---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

vars:
  GIT_HASH:
    sh: git rev-parse --short HEAD
  COMPOSE_CONFIG_FILE: .docker/docker-compose.{{.TARGET}}.yml
  COMPOSE_ENV_FILE: .env

tasks:
  compose-build:
    desc: Build services
    cmds:
      - |
        docker compose \
        --file {{.COMPOSE_CONFIG_FILE}} \
        --env-file {{.COMPOSE_ENV_FILE}} \
        --project-directory . \
        build
    requires:
      vars:
        - name: TARGET
          enum: [localhost, production]

  compose-down:
    desc: Stop services
    cmds:
      - |
        docker compose \
        --file {{.COMPOSE_CONFIG_FILE}} \
        --env-file {{.COMPOSE_ENV_FILE}} \
        --project-directory . \
        down
    requires:
      vars:
        - name: TARGET
          enum: [localhost, production]

  compose-up:
    desc: Start services
    cmds:
      - |
        docker compose \
        --file {{.COMPOSE_CONFIG_FILE}} \
        --env-file {{.COMPOSE_ENV_FILE}} \
        --project-directory . \
        up --detach
    requires:
      vars:
        - name: TARGET
          enum: [localhost, production]

  compose-show-config:
    desc: Show docker-compose config
    cmds:
      - |
        docker compose \
        --file {{.COMPOSE_CONFIG_FILE}} \
        --env-file {{.COMPOSE_ENV_FILE}} \
        --project-directory . \
        config
    requires:
      vars:
        - name: TARGET
          enum: [localhost, production]

  debug:
    desc: Debug
    cmds:
      - echo {{.GIT_HASH}}
